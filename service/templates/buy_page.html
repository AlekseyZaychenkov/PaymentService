{% extends 'base.html' %} {% load widget_tweaks %} {% block content %}
{% load static %}


<div class="col-md-3 card">
    <div class="row d-flex justify-content-center">
        <p class="pt-2">Buy Page</p>
    </div>

    <div class="row d-flex justify-content-center">
        <p class="pt-3">{{item.title}}</p>
    </div>

    <div class="row d-flex justify-content-center">
        <img class="img-fluid img-thumbnail" src={{images_root}}{{item.image_field}} style="height: 400px; object-fit: contain;">
    </div>

    <a type="button" class="btn btn-sm btn-outline-dark buy-button"  style="border-radius: 16px;"
       href="{% url 'buy_by_id' item_id=item.id %}">Buy Buy Buy</a>

</div>


<script type="text/javascript">
    // Create an instance of the Stripe object with your publishable API key
    var stripe = Stripe('pk_test_51IuUC4K.........voa9');

    // Gets all buy buttons
    var buttons = document.getElementsByClassName('buy-button');
    for (i = 0; i < buttons.length; i++) {

   // for every button we will add a Stripe POST request action
    buttons[i].addEventListener('click', function(event) {
    var targetElement = event.target || event.srcElement;
    var productName =  targetElement.value;
    console.log('Buying: ' + productName);

    var data = JSON.stringify({
    item: ["item_1", "item_2"],
    item_quantity: [1, 3]
    })

    // Our endpoint with the chosen product name
    var url = '/create-checkout-session/' + productName
    console.log(url);
    // Create a new Checkout Session
    fetch(url, {
      method: 'POST',
      body: data,
      headers: { 'Accept': 'application/json, text/plain, */*','Content-Type': 'application/json'
        }
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(session) {
      return stripe.redirectToCheckout({ sessionId: session.id });

    })
    .then(function(result) {
      // If `redirectToCheckout` fails due to a browser or network
      // error, you should display the localized error message to your
      // customer using `error.message`.
      if (result.error) {
        alert(result.error.message);
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
    });

    });

    }


{% endblock content %}
